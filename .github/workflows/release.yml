name: Build and Release

on:
    push:
        tags:
            - 'v*'

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Extract Version from Tag
              id: version
              run: |
                  # Extract version from tag (v1.2.3 -> 1.2.3)
                  VERSION=${GITHUB_REF_NAME#v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Release Version: $VERSION"

            - name: Inject Version into Files
              run: |
                  VERSION=${{ steps.version.outputs.version }}
                  
                  # Update package.json
                  jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
                  
                  # Update plugin.json
                  jq --arg v "$VERSION" '.version = $v' plugin.json > plugin.json.tmp && mv plugin.json.tmp plugin.json
                  
                  echo "âœ… Injected version $VERSION into package.json and plugin.json"

            - name: Install dependencies
              run: pnpm install --no-frozen-lockfile

            - name: Build plugin
              run: pnpm build

            - name: Create release zip
              run: |
                  # Create release directory structure
                  mkdir -p release/decky-ukr-badge/dist

                  # Copy required files
                  cp -r dist/* release/decky-ukr-badge/dist/
                  cp main.py release/decky-ukr-badge/
                  cp plugin.json release/decky-ukr-badge/
                  cp package.json release/decky-ukr-badge/
                  cp LICENSE release/decky-ukr-badge/
                  cp README.md release/decky-ukr-badge/

                  # Create zip
                  cd release
                  zip -r ../release.zip decky-ukr-badge
                  cd ..

                  # Cleanup
                  rm -rf release

                  echo "âœ… Created release.zip"
                  unzip -l release.zip

            - name: Generate Changelog
              id: changelog
              run: |
                  # Get previous tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                  CURRENT_TAG=${{ steps.version.outputs.tag }}
                  
                  echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
                  
                  if [ -n "$PREV_TAG" ]; then
                      echo "ğŸ“‹ Generating changelog from $PREV_TAG to $CURRENT_TAG"
                      
                      # Generate changelog from commits
                      CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges | head -20)
                      
                      # Escape for multiline output
                      echo "changelog<<EOF" >> $GITHUB_OUTPUT
                      echo "$CHANGELOG" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT
                  else
                      echo "changelog=- Initial release" >> $GITHUB_OUTPUT
                  fi

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  body: |
                      ## ğŸ‡ºğŸ‡¦ decky-ukr-badge ${{ steps.version.outputs.tag }}

                      ### Installation
                      1. Download `release.zip` below
                      2. On Steam Deck, open **Decky Loader** â†’ âš™ï¸ **Settings** â†’ **Developer**
                      3. Select **Install Plugin From File** and choose the downloaded zip

                      ### Changes
                      ${{ steps.changelog.outputs.changelog }}

                      ---
                      ğŸ“ Auto-generated from commit [`${{ github.sha }}`](https://github.com/yataktyni/decky-ukr-badge/commit/${{ github.sha }})
                      
                      ğŸ”— [Compare with previous release](https://github.com/yataktyni/decky-ukr-badge/compare/${{ steps.changelog.outputs.prev_tag }}...${{ steps.version.outputs.tag }})
                      
                      ğŸ“– [Full documentation](https://github.com/yataktyni/decky-ukr-badge#readme)
                  draft: false
                  prerelease: false
                  files: release.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
