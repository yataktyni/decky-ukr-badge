name: Build and Release

on:
    push:
        branches:
            - main

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Calculate and Update Version
              id: version
              run: |
                  # Extract current version from package.json
                  CURRENT_VERSION=$(jq -r .version package.json)
                  echo "üìÑ Current version: $CURRENT_VERSION"

                  # Split version into components
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

                  # Increment patch version
                  NEW_PATCH=$((PATCH + 1))
                  NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
                  
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "üì¶ New Version: $NEW_VERSION"

                  # Update package.json
                  jq --arg v "$NEW_VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
                  
                  # Update plugin.json
                  jq --arg v "$NEW_VERSION" '.version = $v' plugin.json > plugin.json.tmp && mv plugin.json.tmp plugin.json
                  
                  echo "‚úÖ Updated version files to $NEW_VERSION"

            - name: Install dependencies
              run: pnpm install --no-frozen-lockfile

            - name: Build plugin
              run: pnpm build

            - name: Commit version update
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json plugin.json
                  git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
                  git push origin main
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create release zip
              run: |
                  # Create release directory structure
                  mkdir -p release/decky-ukr-badge/dist

                  # Copy required files
                  cp -r dist/* release/decky-ukr-badge/dist/
                  cp main.py release/decky-ukr-badge/
                  cp plugin.json release/decky-ukr-badge/
                  cp package.json release/decky-ukr-badge/
                  cp LICENSE release/decky-ukr-badge/
                  cp README.md release/decky-ukr-badge/

                  # Create zip
                  cd release
                  zip -r ../release.zip decky-ukr-badge
                  cd ..

                  # Cleanup
                  rm -rf release

                  echo "‚úÖ Created release.zip"
                  unzip -l release.zip

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  body: |
                      ## üá∫üá¶ decky-ukr-badge ${{ steps.version.outputs.tag }}

                      ### Installation
                      1. Download `release.zip` below
                      2. On Steam Deck, open **Decky Loader** ‚Üí ‚öôÔ∏è **Settings** ‚Üí **Developer**
                      3. Select **Install Plugin From File** and choose the downloaded zip

                      ### Changes
                      - Auto-generated release from commit ${{ github.sha }}

                      ---
                      [Full documentation](https://github.com/yataktyni/decky-ukr-badge#readme)
                  draft: false
                  prerelease: false
                  files: release.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
