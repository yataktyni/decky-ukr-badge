name: Build and Release

on:
    push:
        branches:
            - main

jobs:
    build-and-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Get Version
              id: version
              run: |
                  VERSION=$(jq -r .version package.json)
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=v$VERSION" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Release Version: $VERSION"

            - name: Install dependencies
              run: pnpm install --no-frozen-lockfile

            - name: Build plugin
              run: pnpm build

            - name: Create release zip
              run: |
                  # Create release directory structure
                  mkdir -p release/decky-ukr-badge/dist

                  # Copy required files
                  cp -r dist/* release/decky-ukr-badge/dist/
                  cp main.py release/decky-ukr-badge/
                  cp plugin.json release/decky-ukr-badge/
                  cp package.json release/decky-ukr-badge/
                  cp LICENSE release/decky-ukr-badge/
                  cp README.md release/decky-ukr-badge/

                  # Create zip
                  cd release
                  zip -r ../release.zip decky-ukr-badge
                  cd ..

                  # Cleanup
                  rm -rf release

                  echo "âœ… Created release.zip"
                  unzip -l release.zip

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  name: Release ${{ steps.version.outputs.tag }}
                  body: |
                      ## ğŸ‡ºğŸ‡¦ decky-ukr-badge ${{ steps.version.outputs.tag }}

                      ### Installation
                      1. Download `release.zip` below
                      2. On Steam Deck, open **Decky Loader** â†’ âš™ï¸ **Settings** â†’ **Developer**
                      3. Select **Install Plugin From File** and choose the downloaded zip

                      ### Changes
                      - Auto-generated release from commit ${{ github.sha }}

                      ---
                      [Full documentation](https://github.com/yataktyni/decky-ukr-badge#readme)
                  draft: false
                  prerelease: false
                  files: release.zip
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
